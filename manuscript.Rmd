---
title: "It's easier to move sideways"
author:
  - Kaleonani K.C. Hurley:
      institute: 
        - himb
        - nerr
      equal_contributor: yes
      correspondence: yes
      email: "hurleyk@hawaii.edu"
  - Mykle L. Hoban:
      institute:
        - himb
      equal_contributor: yes
  - Molly A. Timmers:
      institute: [himb, natgeo]
  - Kerry Reardon:
      institute: noaa
  - Robert J. Toonen:
      institute: himb
institute:
  - himb: Hawai&#x02BB;i Institute of Marine Biology
  - nerr: He&#x02BB;eia National Estuarine Research Reserve
  - natgeo: National Geographic Pristine Seas
  - noaa: National Oceanic and Atmospheric Administration
abstract:
  Shallow coral reefs are extensively studied, and although scleractinian corals have been recorded to 165 m, little is known about other mesophotic coral reef ecosystem (MCE) inhabitants. Brachyuran crabs fill many ecological and trophic niches on reefs, making them ideal candidates for evaluating species composition among depths. Here we ask if MCEs host the same communities as the shallower reefs spread across the entire 2400 km Hawaiian Archipelago. We deployed Autonomous Reef Monitoring Structures (ARMS) for two years among shallow sites (12 m) across the latitudinal gradient of the Hawaiian Archipelago to compare directly with a depth gradient (12, 30, 60, and 90 m) south of Oʻahu island. A total of 2284 individual crabs representing 90 morphospecies (19 families) were found. Assemblage composition was not statistically significantly different among shallow sites spread across the archipelago but was significantly different and highly stratified across the depth gradient.  We show that 90 m of depth is a more potent determinant of brachyuran community composition than the latitudinal, geographic (high vs low islands), or anthropogenic impact (human population size) gradient across the archipelago. Deeper reefs host significantly different brachyuran communities than shallow ones in Hawai&#x02BB;i, and only 3 of 90 morphospecies (~3%) occurring across the entire depth range (mesophotic to shallow) were sampled. Further research on the cryptic reef-dwelling fauna is needed for identifying areas of unique biodiversity, as well as boundaries between depth-stratified reef ecosystems.
bibliography: references/citations.bib
csl: references/vancouver.csl
output:
  word_document:
    pandoc_args:
      - "--filter=resources/pandoc-crossref"
      - "--lua-filter=resources/scholarly-metadata.lua"
      - "--lua-filter=resources/author-info-blocks.lua"
      - "--reference-doc=resources/ref.docx"
    keep_md: true
tblPrefix: Table
figPrefix:
  - "Fig."
  - "Figs."
---

### Keywords
<div custom-style="mono">ARMs, mesophotic coral ecosystems, community structure, dispersal, Hawai&#x02BB;i, brachyuran crabs</div>
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  fig.path="output/figures/fig-",
  dev="svg",
  dpi=300,
  message=FALSE,
  warning=FALSE
)

library(pander)
library(fs)
library(here)
library(english)

source("crabs.R")
if (!exists("crabs_done")) {
  crabs_done <<- FALSE
}
if (!crabs_done) {
  cc <<- setup_crabs()
  crabs_done <<- TRUE
}

format_range <- function(vals) {
  f <- range(vals)
  str_glue("{f[1]}--{f[2]}")
}

format_species <- function(spp) {
  if (spp$found) {
    str_glue("*{spp$species}* {spp$authority}")
  } else {
    s <- str_split(spp$species," ")[[1]]
    str_glue("*{s[1]}* {s[2]}")
  }
}

num <- function(x,accuracy=0.01) {
  scales::number(x,big.mark = ",",decimal.mark = ".",accuracy=accuracy)
}

t_test <- function(test,plain=FALSE) {
  if (plain) {
    str_glue("*t* = {num(test$statistic,0.01)}, DF = {num(test$parameter['df'],0.01)}, *p* = {num(test$p.value,0.01)}")
  } else {
    str_glue("(two-sample t-test: *t* = {num(test$statistic,0.01)}, DF = {num(test$parameter['df'],0.01)}, *p* = {num(test$p.value,0.01)})")
  }
}

top_list <- function(species,n,units,len=4) {
  s1 <- map_chr(species,format_species)
  s2 <- map2_chr(n,units,~{
    str_glue("(with {.x} individuals on {.y} units)")
  })
  ss <- str_c(s1," ",s2)
  ss[1:(len-1)] %>%
    str_c(collapse=", ") %>%
    str_c(", and ",ss[len])
}

print_table <- function(tbl,id="",caption="") {
  if (!grepl("^: ",caption)) {
    caption <- paste0(": ",caption)
  }
  
  if (inherits(tbl,"character")) {
    if (id == "") {
      id <- sub(pattern = "(.*?)\\..*$", replacement = "\\1", basename(file))
    }
    tbl <- read.csv(tbl,check.names=FALSE,stringsAsFactors=FALSE)
  } else if (inherits(tbl,"data.frame")) {
    if (id == "") stop("please specify table id")
  } else {
    stop("'tbl' must be a character or a data frame")
  }
  
  caption <- sprintf("%s {#tbl:%s}",caption,id)
  
  table_str <- capture.output(pander::pandoc.table(tbl,keep.line.breaks=TRUE,caption=NULL,style="grid",split.cells=Inf,split.tables=Inf,justify='left',missing=''))
  table_str <- table_str[table_str != ""]
  cat(paste0(table_str,collapse="\n"),"\n\n",caption,"\n\n",sep="")
}

cc$crabs_deep <- cc$crabs_untransformed %>% subset_samples(shallow_deep == "deep")
cc$crabs_deep <- prune_taxa(taxa_sums(cc$crabs_deep) > 0,cc$crabs_deep)
cc$crabs_shallow <- cc$crabs_untransformed %>% subset_samples(shallow_deep == "shallow")
cc$crabs_shallow <- prune_taxa(taxa_sums(cc$crabs_shallow) > 0,cc$crabs_shallow)

dir_create(here("cache"))
if (file_exists(here("cache","all_summary.rds"))) {
  all_summary <<- read_rds(here("cache","all_summary.rds"))
} else {
  all_summary <<- sample_summary(cc$crabs_untransformed)
  write_rds(all_summary,here("cache","all_summary.rds"))
}
if (file_exists(here("cache","deep_summary.rds"))) {
  deep_summary <<- read_rds(here("cache","deep_summary.rds"))
} else {
  deep_summary <<- sample_summary(cc$crabs_deep)
  write_rds(deep_summary,here("cache","deep_summary.rds"))
}

all_alpha <- alpha_diversity(cc$crabs_untransformed)
deep_alpha <- alpha_diversity(cc$crabs_deep)
shallow_alpha <- alpha_diversity(cc$crabs_shallow)
```

# Introduction

# Materials and Methods

## Sample Collection

Brachyuran crab assemblages were sampled from benthic coral reef habitat in the Hawaiian Archipelago using Autonomous Reef Monitoring Structures (ARMS). ARMS are standardized collection devices designed to mimic coral reef structural complexity to attract settlement of reef cryptofauna [@brainardAutonomousReefMonitoring2009; @zimmermanArtificialReefMatrix2004]. They are constructed from 10 gray type 1 PVC plates (23 cm $\times$ 23 cm) stacked in an alternating series of open and semi-enclosed layers (figure xxx, ARMS unit). The stack is fastened to a larger base plate (35 cm $\times$ 45 cm) which can be attached to the benthos upon deployment [@brainardAutonomousReefMonitoring2009; @hurleyAssessmentShallowMesophotic2016; @knowltonCoralReefBiodiversity2010; @zimmermanArtificialReefMatrix2004].

A total of 89 ARMS units were deployed over the course of six years (2010--2016). Units were deployed by NOAA scuba divers during Pacific Reef Assessment and Monitoring Program (RAMP) research cruises in shallow coral reef habitat (12–16 m depth) in both the Main (MHI) and Northwest Hawaiian Islands (NWHI) ([@tbl:arms_table]). The sites in the MHI were at Hawai&#x02BB;i Island, Maui, O&#x02BB;ahu, and Kaua&#x02BB;i. The sites in the NWHI were at Lalo (French Frigate Shoals), Kapou (Lisianski), Manawai (Pearl & Hermes), and Hōlanikū (Kure Atoll) ([@fig:site_map]). To explore the effects of depth on crab community structure, we also present data from a previous study by Hurley et al. [-@hurleyAssessmentShallowMesophotic2016], which included a total of 27 units deployed off O&#x02BB;ahu from 2009–2012 in 12–90 m depth; nine units were deployed at 12 m, and six each at 30 m, 60 m, and 90 m ([@tbl:arms_table]). Shallow units were deployed according to standard NOAA methodology, whereas units $\geq$ 30 m were deployed and recovered using technical mixed-gas closed-circuit rebreather diving. 

```{r arms-table,results="asis"}
arms_schedule <- cc$crabs_untransformed %>%
  sample_tibble() %>%
  separate_wider_regex(sample,patterns=c(recovery_year="^[0-9]+","_",sample=".*"))  %>%
  select(sample,everything()) %>%
  unite("range",deployment_year,recovery_year,sep="--") %>%
  mutate(
    island = case_when(
      str_remove_all(hawaiian_name,'[^a-zA-Z ]') != island ~ as.character(str_glue("{hawaiian_name} ({island})")),
      TRUE ~ as.character(hawaiian_name)
    ),
    island = fct_reorder(island,-lat)
  ) %>%
  count(island,range) %>%
  pivot_wider(names_from="range",values_from="n")  %>%
  select(island,order(colnames(.))) %>%
  mutate(across(-island,~replace_na(.x,0)))
print_table(arms_schedule,"arms_table","ARMS unit sampling schedule (number of units)")  
# print_table(here("data","tables","arms_deployment.csv"),"arms_table","ARMS unit sampling schedule (number of units)")
```

```{r site-map, fig.cap='Sampling map (Papahānaumokuākea Marine National Monument shaded in light blue)', results="asis", dev="svg", fig.width=9, fig.height=6}
library(sf)
library(rnaturalearth)

crab_sites <- cc$crabs_untransformed %>%
  sample_tibble() %>%
  distinct(hawaiian_name,island_group,lat,lon,.keep_all = FALSE) %>%
  # mutate( island = fct_reorder(island,-lat) ) %>%
  st_as_sf(coords=c("lon","lat"),crs=4326, remove=F) #%>%

hawaii <- ne_states("united states of america",returnclass = "sf") %>%
  filter(name == "Hawaii")

trans_box <- function(b,crs) {
  box_before <- st_sfc(
    st_point(b[c(1,2)]),
    st_point(b[c(3,4)]),
    crs=4326
  )
  box_before %>%
    st_transform(crs) %>%
    st_bbox()
}

box_before <- st_bbox(st_buffer(crab_sites,units::as_units(50,"km")))

transformer <- str_glue("+proj=leac +lat_1={box_before[2]} +lat_2={box_before[4]} +lon_0={mean(box_before[c(1,3)])}")

box_after <- box_before %>%
  trans_box(transformer)

pmnm <- st_read(here("data","gis","pmnm.shp"),quiet = TRUE) %>%
  st_transform(transformer)

plotz <- ggplot() +
  # geom_contour(data=bath_proj,mapping=aes(x=V1,y=V2,z = V3),  color="#cecece") +
  # geom_raster(data=bpr,aes(x=x,y=y,fill=z)) +
  # geom_tile(data=bath_proj,mapping=aes(x=V1,y=V2,fill = V3)) +
  # scale_fill_gradient2(low="dodgerblue4", mid="gainsboro", high="darkgreen") +
  geom_sf(data=hawaii %>% st_transform(transformer), color="black", fill="green", linewidth=0.4) +
  scale_fill_brewer(palette="Accent",name="Island") +
  geom_sf(data=pmnm,fill="#6ed8f6",alpha=0.1) +
  geom_sf(data=crab_sites %>% st_transform(transformer),aes(fill=hawaiian_name),size=3,shape=21,color="black") +
  coord_sf(xlim=box_after[c(1,3)],ylim=box_after[c(2,4)]) +
  scale_x_continuous(breaks = -seq(180, 155, -5)) +
  theme_minimal() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme(legend.text = element_text(size=10),legend.title = element_text(size=12))
# labela <- tribble(
#   ~lon,~lat,~text,
#   -170,25.4,"Paphānaumokuākea Marine\nNational Monument\n(NWHI)"
# ) %>%
#   st_as_sf(coords=c("lon","lat"),crs=4326, remove=F)  %>%
#   st_transform(transformer)
# 
# plotz +
#   geom_sf_text(aes(label=text),data=labela,size=3,angle=-17.0)
plotz
cat("{#fig:site_map}")
```

ARMS units were retrieved by encapsulating them in-situ in a mesh-lined crate (100 μm pore size) to prevent escape of motile organisms. Once returned to ship or shore, they were placed in containers of aerated, filtered seawater, crates were removed, and units were systematically disassembled plate-by-plate. Seawater surrounding disassembled units was sieved through 2 mm, 500 μm, and 100 μm mesh-size geologic sieves [see @lerayDNABarcodingMetabarcoding2015 for processing details], and retained macroorganisms were preserved in 95% ethanol. All adult brachyuran crabs ($\geq$ 5 mm) were photographed, identified to morphospecies, and preserved in 95% ethanol (Fig. 2d). Individual preserved specimens were accessioned into the invertebrate zoology collections at the Florida Museum of Natural History (catalog numbers xxx–xxx ).

## Data analysis

Unless otherwise specified, all analyses were performed using `R` version 4.1.2 [@rcoreteamLanguageEnvironmentStatistical2021]. Community data were loaded and encapsulated into data objects using the R package `phyloseq` [@mcmurdiePhyloseqPackageReproducible2013] and multivariate community analyses were performed using the package `vegan` [@oksanenVeganCommunityEcology2022] on Bray-Curtis dissimilarities of Hellinger-transformed species abundance matrices [@legendreEcologicallyMeaningfulTransformations2001; @raoReviewCanonicalCoordinates1995].

To examine patterns of crab diversity across the islands, we calculated alpha diversity statistics for ARMS units across the archipelago and examined how those values varied between the MHI and NWHI as well as the effects of environmental factors. We calculated species richness and Simpson diversity using the `estimate_richness` function from phyloseq (Simpson = $1-\sum_{i=1}^{R}p_i^2$, where R is the total number of species, and $\mathrm{p}_i$ is the proportional abundance of each species). Alpha diversity was compared between MHI and NWHI using two-sample t-tests, both with and without the inclusion of mesophotic ARMS units. To explore the effects of environmental factors on alpha diversity across the islands, we used a linear mixed-effect model, with Simpson diversity or richness as response variables, the environmental variables listed below as fixed effects, and island nested within region (MHI vs NWHI) as random effects. Models were generated using the `lmer` function from the `lme4` package [@batesFittingLinearMixedEffects2015]. 

We used the distance-based redundancy analysis method (dbRDA; a form of multivariate multiple regression) implemented in the `dbrda` function from vegan to examine the relative importance of environmental variables on crab community variation across the Hawaiian Islands. We first assessed the importance of each environmental variable individually using marginal tests. Then, a stepwise forward selection procedure (using the function `ordiR2step`) was used to find the suite of environmental variables that best explained the dissimilarity among sites with regard to crab community composition. Colinearity between traits was assessed by calculating variance inflation factors (VIF) using the function `vif.cca` from complete and reduced models and discarding variables where VIF > 10. Significance levels were assessed with the function `anova` using permutation tests with 9,999 permutations. All continuous environmental variables used for dbRDA were scaled to unit variance. We used the permutational analysis of variance (PERMANOVA) method in the `adonis2` function from vegan to assess variation among sites and/or depths across the islands, with 9,999 permutations to assess significance in both term-based and marginal tests.

## Environmental variables

Potential environmental factors affecting the community structure of brachyuran crabs on shallow reefs were assembled from published literature [@selkoeDNACoralReef2016] and the Pacific Islands Ocean Observing System (PacIOOS) ([@tbl:env_table]). Environmental factors were assembled only for shallow sites sampled during RAMP cruises. 

```{r env-table,results="asis"}
print_table(here("data","tables","environmental_variables.csv"),"env_table","Potential environmental drivers of crab community structure, assembled from PacIOOS and @selkoeDNACoralReef2016")
```

# Results

## Diversity summary

### All ARMS

The `r nsamples(cc$crabs_untransformed)` ARMS units deployed across the Hawaiian Islands (in `r format_range(cc$crab_data$depth)` m depth) yielded a total of `r num(sum(sample_sums(cc$crabs_untransformed)),1)` adult crabs. Sampling units contained `r num(all_summary$abundance_mean,0.1)` $\pm$ `r num(all_summary$abundance_sd,0.1)` (mean $\pm$ SD) individuals per unit, and abundance ranged from `r format_range(all_summary$abundance_range)` individuals. Crabs were identified to `r sum(unlist(all_summary$types_breakdown))` distinct types (including `r all_summary$types_breakdown$species` species and `r all_summary$types_breakdown$morphospecies` morphospecies) in `r all_summary$taxonomy_breakdown$genera` genera and `r all_summary$taxonomy_breakdown$families` families, which accounted for ~36% of the known crab diversity reported from Hawaiian waters [@castroCatalogAnomuranBrachyuran2011]. The four most common species were: `r with(all_summary,top_list(top5,top5_n,top5_units))`. `r str_to_sentence(as.english(all_summary$singleton_count))` species occurred in a single unit across all sites (singletons), accounting for ~`r num(all_summary$singleton_count/ntaxa(cc$crabs_untransformed)*100,1)`% of total recovered crab species. 

### Mesophotic ARMS

The `r nsamples(cc$crabs_deep)` units deployed at mesophotic depths $\geq$ 30 m on O&#x02BB;ahu yielded both fewer species and fewer individuals compared to the complete dataset, with `r num(sum(sample_sums(cc$crabs_deep)),1)` crabs overall, a total of `r sum(unlist(deep_summary$types_breakdown))` distinct types (`r deep_summary$types_breakdown$species` species and `r deep_summary$types_breakdown$morphospecies` morphospecies), `r num(deep_summary$abundance_mean,0.1)` $\pm$ `r num(deep_summary$abundance_sd,0.1)` individuals per unit, and abundance ranging from `r format_range(deep_summary$abundance_range)` crabs. The four most abundant species in the deep ARMS did not overlap with those from the complete dataset: `r with(deep_summary,top_list(top5,top5_n,top5_units))`. There were `r deep_summary$singleton_count` singletons, which proportionally accounted for ~`r num(deep_summary$singleton_count/ntaxa(cc$crabs_deep)*100,1)`% of species found on deep ARMS.

## Alpha diversity

### Summary

Overall mean species richness for the complete dataset was `r num(all_alpha$richness,0.1)` $\pm$ `r num(all_alpha$richness_sd,0.1)` species per unit (Simpson diversity: `r num(all_alpha$simpson,0.01)` $\pm$ `r num(all_alpha$simpson_sd,0.01)`). Overall mean species richness for shallow ARMS \< 30 m was `r num(shallow_alpha$richness,0.1)` $\pm$ `r num(shallow_alpha$richness_sd,0.1)` species per unit (Simpson diversity: `r num(shallow_alpha$simpson,0.01)` $\pm$ `r num(shallow_alpha$simpson_sd,0.01)`). Overall mean species richness for mesophotic ARMS $\geq$ 30 m was `r num(deep_alpha$richness,0.1)` $\pm$ `r num(deep_alpha$richness_sd,0.1)` species per unit (Simpson diversity: `r num(deep_alpha$simpson,0.01)` $\pm$ `r num(deep_alpha$simpson_sd,0.01)`). 

### Comparisons

For the complete dataset, there was no significant difference in observed species richness between the MHI and NWHI `r t_test(all_alpha$t_r_island)`, but Simpson diversity was significantly different, although mean values were similar with `r num(all_alpha$richness_main$richness,0.1)` $\pm$ `r num(all_alpha$richness_main$richness_sd,0.1)` in the MHI and `r num(all_alpha$richness_nwhi$richness,0.1)` $\pm$ `r num(all_alpha$richness_nwhi$richness_sd,0.1)` in the NWHI ([@fig:alpha_box]; `r t_test(all_alpha$t_s_island,plain=TRUE)`). When only shallow arms \< 30 m were considered, neither comparison was significant (richness: `r t_test(shallow_alpha$t_r_island,plain=TRUE)`; Simpson: `r t_test(shallow_alpha$t_s_island,plain=TRUE)`)<!--(richness: t = 0.77, DF = 94.47, p = 0.44; Simpson: t  = 1.93, DF = 84.76, p = 0.06)-->.

```{r alpha-box, fig.cap='Hello Dolly', results="asis", dev="svg", fig.width=10, fig.height=8}
ggplot(all_alpha$richness_table) + 
  geom_boxplot(aes(x=island_group,y=Simpson,fill=island_group)) +
  scale_fill_brewer(palette="Set2") +
  theme_bw() + 
  theme(panel.grid = element_blank())
cat("{#fig:alpha_box}")
```

### Effects of environmental variables


# Discussion

# References 

::: {#refs}
:::

