---
title: 'Cryptobenthic reef assemblages are more distinct across a 90 m depth gradient than 2,500 km of shallow marine habitat in the Hawaiian Archipelago'
author:
  - Kaleonani K.C. Hurley:
      institute:
        - himb
      equal_contributor: yes
  - Mykle L. Hoban:
      institute:
        - himb
      equal_contributor: yes
      correspondence: yes
      email: "mhoban@hawaii.edu"
  - Kerry Reardon:
      institute: noaa
  - Derek J. Skillings:
      institute: 
        - uncg
  - Molly A. Timmers:
      institute:
        - himb
        - natgeo
  - Robert J. Toonen:
      institute: himb
institute:
  - himb: Hawai&#x02BB;i Institute of Marine Biology, University of Hawai&#x02BB;i, MƒÅnoa
  - noaa: National Oceanic and Atmospheric Administration
  - uncg: 'University of North Carolina, Greensboro'
  - natgeo: National Geographic Pristine Seas
abstract:
  An inability to consistently resolve the environmental and anthropogenic factors that shape coral reefs impacts our understanding of how those factors interact and how coral reef communities may respond to change. Logistical challenges have additionally limited the taxonomic resolution and depth ranges investigated, with the focus largely on fishes and corals in the shallowest ~30 m of coral reefs. Here, we examine the effects of a suite of environmental, ecological, and anthropogenic factors on the assemblage structure of brachyuran crabs recovered from Autonomous Reef Monitoring Structures on shallow reefs (8--17 m) across the ~2,500 km span of the Hawaiian Archipelago. We compare these assemblages with those sampled along a depth gradient (12--90 m) on O&#x02BB;ahu. We found 2,284 individuals representing 103 (morpho)species from 22 families. Shallow assemblages were significantly different between the Main and Northwest Hawaiian Islands and significantly associated with human impacts, chlorophyll-A, sea-surface temperature, slope, potential larval connectivity, and depth. However, we found more variation among mesophotic samples from O&#x02BB;ahu (30--90 m) than among shallow samples across the entire archipelago, suggesting that 90 m of depth is a stronger determinant of brachyuran assemblage structure than the latitudinal, environmental, or anthropogenic gradients across the Hawaiian Islands.
bibliography: references/citations.json
csl: references/style.csl
output:
  word_document:
    pandoc_args:
      - "--toc-depth=2"
      - "--filter=resources/pandoc-crossref"
      - "--lua-filter=resources/scholarly-metadata.lua"
      - "--lua-filter=resources/author-info-blocks.lua"
      - "--reference-doc=resources/ref.docx"
    keep_md: false
tblPrefix: table
figPrefix:
  - "figure"
  - "figures"
chapters: True
chaptersDepth: 1
chapDelim: ""
header-includes:
  - \usepackage{bm}
  - \usepackage{upgreek}
---
<!--word count: Proceedings B publishes articles up to 12 pages, including figures and tables, with no more than 10 000 words. The word count includes the title page, author names, abstract, figure legends, tables and the reference list. As a rough guide, 10 000 words = 12 pages without additional figures; 850 words = 1 page and 2-4 small figures = 1 page. For example, an acceptable paper could be made up of 9 000 words and 4 small figures or 8500 words, 2 large figures and 4 small figures.-->
### Keywords {-}
<div custom-style="mono">ARMs, mesophotic coral ecosystems, community structure, dispersal, Hawai&#x02BB;i, brachyuran crabs</div>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  fig.path="output/figures/fig-",
  dev="svg",
  dpi=300,
  message=FALSE,
  warning=FALSE,
  cache=TRUE,
  cache.path = "cache/",
  cache.comments=FALSE
)

library(tidyverse)
library(pander)
library(fs)
library(here)
library(english)
library(phyloseq) 
library(vegan)
library(ggrepel)
library(here)
library(worrms)
library(BiodiversityR)
library(ggtext)

# set random seed for consistency
set.seed(31337)
```

```{r init, include=FALSE}
source("crabs.R")

if (!exists("crabs_done")) {
  crabs_done <<- FALSE
}
if (!crabs_done) {
  cc <<- setup_crabs()
  crabs_done <<- TRUE
}

format_range <- function(vals) {
  f <- range(vals)
  str_glue("{f[1]}--{f[2]}")
}

plotz_theme <- function() {
  theme_bw() + 
    theme(
      legend.key = element_blank(),
      panel.grid = element_blank()
    )
}

format_species <- function(...) UseMethod("format_species")

format_species.list <- function(spp,authority=TRUE,...) {
  if (spp$found) {
    a <- ifelse(authority,str_glue(" {spp$authority}"),"")
    str_glue("*{spp$species}*{a}")
  } else {
    s <- str_split(spp$species," ")[[1]]
    str_trim(str_glue("*{s[1]}* {s[2]}"))
  }
}

format_species.character <- function(species,found,authority,auth=TRUE,...) {
  spp <- map2_chr(species,found,~{
    .y <- ifelse(is.na(.y),FALSE,.y)
    s <- list(species=.x,found=.y,authority="")
    format_species(s,FALSE)
  })
  if (auth) {
    authority <- if_else(!is.na(authority),str_c(" ",authority),"")
    spp <- str_c(spp,authority)
  }
  return(spp)
}

format_species.data.frame <- function(spp,authority=TRUE,...) {
  spp %>%
    pwalk(~{
      row <- list(...)
      s <- row[c('species','found','authority','otu')]
      print(format_species(s,authority))
    })
}

pc <- function(x,a=0.01) scales::percent_format(accuracy = a)(x)
num <- function(x,a=0.01) scales::label_comma(accuracy=a)(x)

w_test <- function(test,plain=FALSE) {
  if (plain) {
    str_glue("*W* = {num(test$statistic,0.01)}, {pval(test$p.value)}")
  } else {
    str_glue("(Wilcoxon rank sum test: *W* = {num(test$statistic,0.01)}, {pval(test$p.value)})")
  }
}

k_test <- function(test,plain=FALSE) {
  if (plain) {
    str_glue("*K-W $\\upchi^2$* = {num(test$statistic,0.01)}, DF = {num(test$parameter['df'],0.01)}, {pval(test$p.value)}")
  } else {
    str_glue("Kruskal-Wallis rank sum test: *K-W $\\upchi^2$* = {num(test$statistic,0.01)}, DF = {num(test$parameter['df'],0.01)}, {pval(test$p.value)}")
  }
}

t_test <- function(test,plain=FALSE) {
  if (plain) {
    str_glue("*t* = {num(test$statistic,0.01)}, DF = {num(test$parameter['df'],0.01)}, {pval(test$p.value)}")
  } else {
    str_glue("(two-sample t-test: *t* = {num(test$statistic,0.01)}, DF = {num(test$parameter['df'],0.01)}, {pval(test$p.value)})")
  }
}

pval <- function(p) {
  case_when(
    p < 0.001 ~ "*p* \\< 0.001",
    p < 0.01 ~ "*p* \\< 0.01",
    TRUE ~ as.character(str_glue("*p* = {num(p,0.01)}"))
  )
}

permdisp <- function(bd,accuracy=0.01,perm=999) {
  a <- anova(bd,permutations=perm) %>%
    broom::tidy() %>%
    filter(term == "Groups")
  with(a,str_glue("DF = {num(df,accuracy)}, SS = {num(sumsq,accuracy)}, F = {num(statistic,accuracy)}, {pval(p.value)}"))
}

permanova <- function(modl,accuracy=0.01,stat="pseudo-F",by=NULL,sentence=TRUE) {
  has_r2 <- TRUE
  if (is(modl,"dbrda")) {
    modl <- anova(modl,by=by)
    has_r2 <- FALSE
  }
  m <- suppressWarnings(broom::tidy(modl)) %>%
    filter(!term %in% c("Total","Residual"))
  if (nrow(m) > 1) {
    m %>%
      pmap_chr(~{
        with(list(...), {
          if (has_r2) {
            r2 <- str_glue(" $\\mathrm{{R}}^2$ = {num(R2,0.01)},") 
          } else {
            r2 <- ""
          }
          if (sentence) {
            term <- str_replace_all(term,"_"," ")
          }
          str_glue("{term}: DF = {num(df,accuracy)}, SS = {num(SumOfSqs,accuracy)},{r2} {stat} = {num(statistic,accuracy)}, {pval(p.value)}")
        })
      }) %>%
      str_c(collapse = "; ")
  } else {
    with(m %>% slice(1),{
      if (has_r2) {
        r2 <- str_glue(" $\\mathrm{{R}}^2$ = {num(R2,accuracy)},") 
      } else {
        r2 <- ""
      }
      if (sentence) {
        term <- str_replace_all(term,"_"," ")
      }
      str_glue("{term}: DF = {num(df,accuracy)}, SS = {num(SumOfSqs,accuracy)},{r2} {stat} = {num(statistic,accuracy)}, {pval(p.value)}")
      # str_glue("DF = {num(df,accuracy)}, SS = {num(SumOfSqs,accuracy)}, $\\mathrm{{R}}^2$ = {num(R2,accuracy)}, pseudo-F = {num(statistic,accuracy)}, {pval(p.value)}")
    }) 
  }
}

top_list <- function(species,n,units,len=4,fig=NULL) {
  s1 <- map_chr(species,format_species)
  s2 <- map2_chr(n,units,~{
    if (is.null(fig)) {
      str_glue("({.x} individuals on {.y} units)")
    } else {
      str_glue("({.x} individuals on {.y} units; [@fig:{fig}[]{{{{}}}}{{.y}}])")
    }
  })
  if (!is.null(fig)) {
    s2 <- map2_chr(s2,letters[seq(length(s2))],~str_glue(.x))
  }
  ss <- str_c(s1," ",s2)
  ss[1:(len-1)] %>%
    str_c(collapse=", ") %>%
    str_c(", and ",ss[len])
}

print_table <- function(tbl,id="",caption="",hdr_case="sentence",hide=character(0),accuracy = 0.01,format_numbers=TRUE, cell_width = Inf) {
  if (!grepl("^: ",caption)) {
    caption <- paste0(": ",caption)
  }
  
  if (inherits(tbl,"character")) {
    if (id == "") {
      id <- sub(pattern = "(.*?)\\..*$", replacement = "\\1", basename(file))
    }
    tbl <- read.csv(tbl,check.names=FALSE,stringsAsFactors=FALSE)
  } else if (inherits(tbl,"data.frame")) {
    if (id == "") stop("please specify table id")
  } else {
    stop("'tbl' must be a character or a data frame")
  }
  
  tbl <- tbl %>%
    select(-any_of(hide)) %>%
    mutate(
      across(
        where(~format_numbers & is.numeric(.x)),
        ~num(.x,accuracy)
      )
    )
  
  
  # can also use rename_with(str_to_sentence)
  names(tbl) <- switch(
    str_to_lower(hdr_case),
    sentence = str_to_sentence(names(tbl)),
    title = str_to_title(names(tbl)),
    upper = str_to_upper(names(tbl)),
    lower = str_to_lower(names(tbl)),
    names(tbl)
  )
  
  caption <- sprintf("%s {#tbl:%s}",caption,id)
  
  table_str <- pander::pandoc.table.return(
    tbl,
    keep.line.breaks=TRUE,
    caption=NULL,
    style="grid",
    split.cells=cell_width,
    split.tables=Inf,
    justify='left',
    missing=''
  )
  table_str <- table_str[table_str != ""]
  cat(paste0(table_str,collapse="\n"),"\n\n",caption,"\n\n",sep="")
}

cc$crabs_deep <- cc$crabs_untransformed %>% subset_samples(shallow_deep == "deep")
cc$crabs_deep <- prune_taxa(taxa_sums(cc$crabs_deep) > 0,cc$crabs_deep)
cc$crabs_shallow <- cc$crabs_untransformed %>% subset_samples(shallow_deep == "shallow")
cc$crabs_shallow <- prune_taxa(taxa_sums(cc$crabs_shallow) > 0,cc$crabs_shallow)

dir_create(here("cache"))
if (file_exists(here("cache","all_summary.rds"))) {
  all_summary <<- read_rds(here("cache","all_summary.rds"))
} else {
  all_summary <<- sample_summary(cc$crabs_untransformed,4)
  write_rds(all_summary,here("cache","all_summary.rds"))
}
if (file_exists(here("cache","deep_summary.rds"))) {
  deep_summary <<- read_rds(here("cache","deep_summary.rds"))
} else {
  deep_summary <<- sample_summary(cc$crabs_deep,4)
  write_rds(deep_summary,here("cache","deep_summary.rds"))
}

all_alpha <- alpha_diversity(cc$crabs_untransformed)
deep_alpha <- alpha_diversity(cc$crabs_deep)
shallow_alpha <- alpha_diversity(cc$crabs_shallow)

island_pal <- c(
  "Hawaii Island" = "#5E4FA2",
  "Hawai‚Äòi Island" = "#5E4FA2",
  "Maui" = "#3288BD",
  "Oahu" = "#66C2A5",
  "O‚Äòahu" = "#66C2A5",
  "Kauai" = "#ABDDA4",
  "Kaua‚Äòi" = "#ABDDA4",

  "French Frigate Shoals" = "#FDAE61",
  "Lalo" = "#FDAE61",
  "Lalo (French Frigate Shoals)" = "#FDAE61",
  "Lisianski" = "#F46D43",
  "Kapou" = "#F46D43",
  "Kapou (Lisianski)" = "#F46D43",
  "Pearl and Hermes Reef" = "#D53E4F",
  "Manawai" = "#D53E4F",
  "Manawai (Pearl and Hermes Reef)" = "#D53E4F",
  "Kure Atoll" = "#9E0142",
  "H≈çlanik≈´" = "#9E0142",
  "H≈çlanik≈´ (Kure Atoll)" = "#9E0142"
)
island_group_pal <- c(
  "main" = "#ffb400",
  "Main" = "#ffb400",
  "Northwest" = "#9080ff",
  "northwest" = "#9080ff"
)

# colors for sample group / depth zone
sample_depth_pal <- c(
  "shallow" = "#ffb400",
  "Shallow" = "#ffb400",
  "Shallow (MHI)" = "#ffb400",
  "shallow_main" = "#ffb400",
  "Shallow (NWHI)" = "#9080ff",
  "shallow_nwhi" = "#9080ff",
  "30 m" = "#d87939",
  "30m" = "#d87939",
  "60 m" = "#04c3c8",
  "60m" = "#04c3c8",
  "90 m" = "#04738d",
  "90m" = "#04738d",
  "deep" = "#04738d",
  "Deep" = "#04738d",
  "O‚Äòahu (shallow)" = "#e5ab52",
  "O‚Äòahu 30 m" = "#d87939",
  "O‚Äòahu 30m" = "#d87939",
  "O‚Äòahu 60 m" = "#04c3c8",
  "O‚Äòahu 60m" = "#04c3c8",
  "O‚Äòahu 90 m" = "#04738d",
  "O‚Äòahu 90m" = "#04738d",
  "O‚Äòahu deep" = "#04738d",
  "O‚Äòahu Deep" = "#04738d"
)

PERM <<- 999

model_terms <- read_csv(here("data","tables","environmental_variables.csv"))
```

# Introduction {-}

Coral reefs are among the most diverse habitats in the world, and they face increasing threats of degradation, including climate-driven bleaching and phase shifts to alternate ecological regimes [@grahamManagingResilienceReverse2013; @norstromAlternativeStatesCoral2009; @pandolfiGlobalTrajectoriesLongterm2003]. In the face of these threats, understanding drivers of metazoan community structure in coral reef ecosystems is critically important [@hughesRisingChallengeSustaining2010; @pageSeekingResistanceCoral2019], particularly as the search for criteria to prioritize climate refugia such as upwelling zones or mesophotic reefs intensifies. While the structure and composition of coral reef communities is influenced by a suite of environmental and anthropogenic factors, the nature and makeup of those factors remain poorly resolved [@hughesCommunityStructureDiversity1989; @smithEffectsTopBottom2010; @brandlCoralReefEcosystem2019]. One aspect of coral reef community structure that is thought to be important but remains under-investigated is depth. Most studies to date have focused on the upper ~30 m of the water column, yet coral reefs and associated communities are known to extend beyond 150 m [@pyleExploringDeepCoral1996; @pyleMesophoticCoralEcosystems2019], with photosymbiotic corals reported to 170 m [@rouzeSymbioticAssociationsDeepest2021]. As much as two thirds of coral reef ecosystems lie in this under-explored zone [@hindersteinThemeSectionMesophotic2010]. These habitats, known as mesophotic coral ecosystems (MCEs), are typically defined as those extending from ~30--150 m depth [@hindersteinThemeSectionMesophotic2010; @kahngCommunityEcologyMesophotic2010]. They have been hypothesized as possible refugia from climate change impacts on shallow reefs [@glynnCoralReefBleaching1996; @bongaertsAssessingDeepReef2010; @smithDepthRefugiumCatastrophic2014; @holsteinFertileFathomsDeep2015; @muirSpeciesIdentityDepth2017], although a growing number of studies have found evidence that mesophotic reefs are unique and uniquely threatened, challenging this notion [@diazLightTemperatureDrive2023; @diazMesophoticCoralBleaching2023; @hobanPlumbingDepthsEnvironmental2023; @hurleyAssessmentShallowMesophotic2016; @kaneHighLevelsMesophotic2014; @pinheiroDeepReefFishes2019; @rochaMesophoticCoralEcosystems2018; @montgomeryCommunitySimilaritySpecies2021]. 

The Hawaiian Archipelago, stretching across ~2,500 km in the North Pacific Ocean, provides a natural laboratory to examine drivers of metazoan community structure. This chain of islands comprises two regions, the inhabited high islands of the main Hawaiian Islands (MHI) and the uninhabited low islands, atolls, and banks of the Northwestern Hawaiian Islands (NWHI) which reside within one of the world's largest marine protected areas---the PapahƒÅnaumokuƒÅkea Marine National Monument. The island chain is subject to considerable anthropogenic and physical gradients driving differences in temperature, coral cover, human population, and anthropogenic impact, among others, all of which influence coral reef communities [@selkoeMapHumanImpacts2009]. Nearshore drop-offs along the island chain also allow access to deeper reef habitat, enabling the examination of depth influences on community structure.

To date, the majority of studies that have examined community structure across the Hawaiian archipelago and along a depth gradient have focused on conspicuous taxa such as corals and fishes [e.g., @benfieldComparisonCoralReef2008; @caballero-aragonWaveExposureTemperature2023; @kaneTrophicDesignationLive2017; @langeWaveExposureShapes2021; @vanlierHabitatConnectivityComplexity2018]. However, these taxa make up a minority of coral reef biodiversity and thus may not be indicative of community patterns overall [@fautinOverviewMarineBiodiversity2010]. Furthermore, studies on these taxa have also been criticized for confounding multiple potentially covarying factors (such as habitat area and/or complexity) across the measured gradients [e.g., @bellwoodRegionalscaleAssemblyRules2001; @grahamEffectsMarineReserve2003; @connollyCommunityStructureCorals2005; @ewersConfoundingFactorsDetection2006; @fletcherRoleHabitatArea2007].  

Here, we used autonomous reef monitoring structures (ARMS)---standardized collection devices designed to mimic reef structural complexity---to sample cryptic communities while controlling for habitat [@zimmermanArtificialReefMatrix2004; @brainardAutonomousReefMonitoring2009]. We targeted brachyuran crabs, a group comprising a notable proportion of the coral reef cryptofauna [284 species in Hawai&#x02BB;i, @castroCatalogAnomuranBrachyuran2011], recovered from these structures to examine drivers of community composition across the Hawaiian Archipelago. We compared crab communities among islands and regions (MHI vs. NWHI) and examined the effects of a suite of possible environmental and anthropogenic drivers of community structure to test hypotheses about their relative importance. 

Much of our understanding of biotic zonation and community structure in the ocean originates with classic studies from the intertidal [e.g., @connellInfluenceInterspecificCompetition1961; @connellEffectsCompetitionPredation1961; @paineIntertidalCommunityStructure1974]. While there are no shortages of exceptions, a long history of studies point towards a generalization that the lower bathymetric limits are generally regulated by ecological interactions whereas upper limits of intertidal communities are more often determined by abiotic factors [@stephenson1972life; @mengeRockyIntertidalCommunities2001; @bertnessTestingRelativeContribution1999; @dennyPhysicalProcessesThat2001]. However, most of these models describe zonation at specific localities rather than community variation over larger spatial scales [but see @birdTideWaveMarks2013; @bishop-taylorTidesModellingElevation2019] and may not apply to coral reefs, which are subject to more complex community dynamics [@abramsRecruitmentLotteriesCoexistence1984; @bussCompetitiveNetworksNontransitive1979; @hixonPredationPreyRefuges1993; @hubbellUnifiedNeutralTheory2011; @moraEcologyFishesCoral2015; @saleStockrecruitRelationshipsRegional1982; @sheppardBiologyCoralReefs2017]. While there is little doubt that ecological interactions are important on coral reefs, the suite of factors and which play the most important role in structuring coral reef communities remains a subject of considerable debate [@bellwoodRegionalscaleAssemblyRules2001; @connollyUnifiedModelExplains2017; @hubbellUnifiedNeutralTheory2011; @jacksonAdaptationDiversityReef1991; @mumbyCoralReefHabitats2008; @saleMaintenanceHighDiversity1977]. 

Given the strong reported differences between deep and shallow reefs across taxa and the paucity of research on drivers of cryptic coral reef community variation, we sought to answer the following four research questions: (i) How do shallow reef brachyuran crab assemblages vary along the natural and anthropogenic gradients of the Hawaiian Archipelago? (ii) Do shallow reef brachyuran crab assemblages differ between the Main and Northwestern Hawaiian Islands? (iii) What environmental and anthropogenic factors drive crab assemblage structure in shallow coral reefs across the Hawaiian Archipelago? (iv) What are the relative contributions of depth (shallow vs. mesophotic) and island region to crab community variation across the Hawaiian Archipelago?

# Materials and Methods {-}

## Sample Collection {-}

Brachyuran crab assemblages were sampled from benthic coral reef habitat in the Hawaiian Archipelago using Autonomous Reef Monitoring Structures (ARMS) collected by NOAA's Ecosystem Science Division as part of its Pacific Reef Assessment and Monitoring Program. ARMS are standardized collection devices designed to mimic coral reef structural complexity to attract settlement of reef cryptofauna [@zimmermanArtificialReefMatrix2004; @brainardAutonomousReefMonitoring2009]. They are constructed from 10 gray type 1 PVC plates (23 cm $\times$ 23 cm) stacked in an alternating series of open and semi-enclosed layers ([@fig:fig_arms]). The stack is fastened to a larger base plate (35 cm $\times$ 45 cm) which can be attached to the benthos upon deployment [@brainardAutonomousReefMonitoring2009; @hurleyAssessmentShallowMesophotic2016; @knowltonCoralReefBiodiversity2010; @zimmermanArtificialReefMatrix2004]. 

![Autonomous reef monitoring structures (ARMS) deployed in the Hawaiian Archipelago.](data/images/arms_example.png){#fig:fig_arms}

<br><br>

A total of 89 ARMS units were deployed over the course of six years (2009--2016) in shallow coral reef habitat (8--17 m depth) in both the Main (MHI) and Northwest Hawaiian Islands (NWHI) ([@fig:fig_map; @tbl:arms_table]). To explore the effects of depth, we also present data from an earlier study by Hurley et al. [-@hurleyAssessmentShallowMesophotic2016], in which 27 units were deployed off O&#x02BB;ahu from 2009--2012 in 12--90 m depth; nine units were deployed at 12 m, and six each at 30 m, 60 m, and 90 m ([@tbl:arms_table]). Shallow units were deployed according to NOAA-RAMP methodology, whereas units $\geq$ 30 m were deployed and recovered using technical mixed gas closed-circuit rebreather diving [see @hurleyAssessmentShallowMesophotic2016]. 

```{r fig-map, fig.cap='Map of ARMS deployment sites across the Hawaiian Archipelago (PapahƒÅnaumokuƒÅkea Marine National Monument (NWHI) is shaded in light blue).', results="asis", fig.width=9, fig.height=6, dependson="init"}
library(sf)
library(rnaturalearth)

crab_sites <- cc$crabs_untransformed %>%
  sample_tibble() %>%
  distinct(hawaiian_name,island,island_group,lat,lon,.keep_all = FALSE) %>%
  mutate(
    island = case_when(
      str_remove_all(hawaiian_name,'[^a-zA-Z ]') != island ~ as.character(str_glue("{hawaiian_name} ({island})")),
      TRUE ~ as.character(hawaiian_name)
    ),
    island = fct_reorder(island,-lat)
  ) %>%
  st_as_sf(coords=c("lon","lat"),crs=4326, remove=F) #%>%

hawaii <- ne_states("united states of america",returnclass = "sf") %>%
  filter(name == "Hawaii")

trans_box <- function(b,crs) {
  box_before <- st_sfc(
    st_point(b[c(1,2)]),
    st_point(b[c(3,4)]),
    crs=4326
  )
  box_before %>%
    st_transform(crs) %>%
    st_bbox()
}

shift_box <- function(b) {
  if (b['xmin'] < 0) 
    b['xmin'] <- b['xmin'] + 360
  if (b['xmax'] < 0) 
    b['xmax'] <- b['xmax'] + 360
  return(b)
}


pmnm <- st_read(here("data","gis","hi_noaa_nwhi_papahanaumokuakea.shp"),quiet = TRUE) %>%
  st_shift_longitude() 

pbox <- st_bbox(pmnm)
cbox <- st_bbox(st_buffer(crab_sites,units::as_units(50,"km")) %>% st_shift_longitude())
hbox <- hawaii %>%
  st_shift_longitude() %>%
  st_bbox()

box_before <- c(
  xmin = min(c(pbox['xmin'],hbox['xmin'],hbox['xmin'])),
  ymin = min(c(pbox['ymin'],cbox['ymin'],hbox['ymin'])),
  xmax = max(c(pbox['xmax'],cbox['xmax'],hbox['xmax'])) + 1.5,
  ymax = max(c(pbox['ymax'],cbox['ymax'],hbox['ymax']))
)


transformer <- str_glue("+proj=leac +lat_1={box_before[2]} +lat_2={box_before[4]} +lon_0={mean(box_before[c(1,3)])}")

box_after <- box_before %>%
  trans_box(transformer)

pmnm <- pmnm %>%
  st_transform(transformer)


ggplot() +
  geom_sf(data=hawaii %>% st_transform(transformer), color="black", fill="#A3866A", linewidth=0.4) +
  geom_sf(data=pmnm,color=NA,fill="#6ed8f6",alpha=0.2) +
  geom_sf(data=crab_sites %>% st_transform(transformer),aes(fill=island),size=3,shape=21,color="black") +
  scale_fill_manual(values=island_pal,name="Island") +
  coord_sf(xlim=box_after[c(1,3)],ylim=box_after[c(2,4)]) +
  scale_x_continuous(breaks = -seq(180, 155, -5)) +
  theme_minimal() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme(legend.text = element_text(size=10),legend.title = element_text(size=12))
cat("{#fig:fig_map}")
```

<br><br>

```{r arms-table,results="asis", dependson="init"}
arms_schedule <- cc$crabs_untransformed %>%
  sample_tibble() %>%
  # separate_wider_regex(sample,patterns=c(recovery_year="^[0-9]+","_",sample=".*"))  %>%
  # select(sample,everything()) %>%
  unite("range",deployment_year,recovery_year,sep="--") %>%
  mutate(
    island = case_when(
      str_remove_all(hawaiian_name,'[^a-zA-Z ]') != island ~ as.character(str_glue("{hawaiian_name} ({island})")),
      TRUE ~ as.character(hawaiian_name)
    ),
    island = case_when(
      island == "O‚Äòahu" ~ str_glue("{hawaiian_name} ({shallow_deep})"),
      TRUE ~ island
    ),
    island = fct_reorder(island,-lat)
  ) %>%
  count(island,range) %>%
  pivot_wider(names_from="range",values_from="n")  %>%
  select(island,order(colnames(.))) %>%
  mutate(across(-island,~replace_na(.x,0)))
print_table(arms_schedule,"arms_table","Recovered ARMS unit soak times across sites (number of units)",accuracy=1) 
```

<br><br>

ARMS units were retrieved by encapsulating them in-situ in a 100 Œºm mesh-lined crate to prevent escape of motile organisms. Once returned to the surface, they were placed in containers of aerated, filtered seawater, crates were removed, and units were systematically disassembled plate-by-plate [see @lerayDNABarcodingMetabarcoding2015 for processing details]. All adult brachyuran crabs ($\geq$ 2 mm) were photographed, identified, and preserved in 95% ethanol. Identifications were made to species level where possible, otherwise crabs were classified into morphospecies represented by suites of shared morphological characters according to expert advice and Poore & Ahyong [-@pooreMarineDecapodCrustacea2023].<!-- Specimens were collected under permits #xxx (NWHI) and #xxx (MHI) and accessioned into the invertebrate zoology collections at the Florida Museum of Natural History (catalog numbers xxx--xxx).--> 

## Data analysis {-}

Unless otherwise specified, all analyses were performed using `R` version 4.1.2 [@rcoreteamLanguageEnvironmentStatistical2021]. Community matrices were loaded and encapsulated into data objects using the R package `phyloseq` [@mcmurdiePhyloseqPackageReproducible2013] and multivariate community analyses were performed using the package `vegan` [@oksanenVeganCommunityEcology2022] on Bray-Curtis dissimilarities of Hellinger-transformed species abundance matrices [@legendreEcologicallyMeaningfulTransformations2001; @raoReviewCanonicalCoordinates1995]. 

To examine patterns of crab diversity across the islands, we used `estimate_richness` to calculate species richness and effective Simpson diversity (effective Simpson = $\frac{1}{\sum_{i=1}^{R}p_i^2}$, where R is the total number of species, and $\mathrm{p}_i$ is the proportional abundance of each species). The effective Simpson index (the inverse of the "classic" Simpson entropy), which has units of species, is easier to interpret in an ecological context than an entropic non-linear index [@jostEntropyDiversity2006; @tuomistoUpdatedConsumerGuide2012]. We used nonparametric Kruskal-Wallis ranked sum tests to compare diversity between shallow and mesophotic samples and between island groups (MHI vs. NWHI). Island group comparisons were performed both including and excluding mesophotic samples.  

We used distance-based redundancy analysis (dbRDA; a form of multivariate multiple regression) with `dbrda` to examine the relative contribution of environmental variables ([@tbl:env_table]) to crab community variation across the islands, conditioning the recovery year as a random effect. From a model incorporating all potential drivers, we sequentially removed variables with the largest variance inflation factors (VIF; calculated using `vif.cca`) until all values were <3, indicating variables were sufficiently uncorrelated. Model significance was assessed using permutation tests with `r num(PERM,1)` permutations with the function `anova`. Continuous variables were scaled to unit variance. 

We assessed variation among groups using `betadisper` and `adonis2`. These functions implement analysis of multivariate homogeneity of group dispersions (PERMDISP) and multivariate permutational analysis of variance (PERMANOVA) respectively. PERMDISP is used to assess variability within groups and PERMANOVA is used to assess differences among groups. Significance was assessed with permutation tests in both cases. Variation among sampling groups (island group and sampling depth) was further examined and visualized using canonical analysis of principal coordinates (CAP) based on discriminant analysis [@andersonCanonicalAnalysisPrincipal2003] as implemented in the `CAPdiscrim` function in `BiodiversityR` [@kindtTreeDiversityAnalysis2005]. 

## Environmental variables {-}

Potential drivers of shallow crab community structure were assembled from a previous study examining environmental effects on genetic diversity [@selkoeDNACoralReef2016], NOAA's National Coral Reef Monitoring Program (NCRMP), the Pacific Islands Ocean Observing System (PacIOOS), and MODIS satellite data products compiled by NASA's Physical Oceanography/Ocean Biology Distributed Active Archive Centers (PO.DAAC, OB.DAAC) ([@tbl:env_table; @tbl:arms_metadata_table]). Sea-surface temparature (SST) and chlorophyll (Chl-A) values were calculated by averaging monthly means for the duration of the soaking period at each sampling site. For details on satellite data preparation and data sources, see Supplemental material. Due to logistical limitations, environmental data were collected only for shallow samples (\< 30 m).

```{r env-table,results="asis", dependson="init"}
print_table(model_terms,"env_table","Potential environmental drivers of crab community structure across the Hawaiian Archipelago",hide="variable")
```

<br><br>

# Results {-}

## Diversity summary {-}

### All ARMS {-}

The `r nsamples(cc$crabs_untransformed)` ARMS units deployed across the Hawaiian Islands (in `r format_range(cc$crab_data$depth)` m depth) yielded a total of `r num(sum(sample_sums(cc$crabs_untransformed)),1)` adult crabs. Units contained `r num(all_summary$abundance_mean,0.1)` $\pm$ `r num(all_summary$abundance_sd,0.1)` (mean $\pm$ SD) individuals, and abundance ranged from `r format_range(all_summary$abundance_range)`. Crabs were identified to `r sum(unlist(all_summary$types_breakdown))` distinct types (`r all_summary$types_breakdown$species` species and `r all_summary$types_breakdown$morphospecies` morphospecies) in `r all_summary$taxonomy_breakdown$genera` genera and `r all_summary$taxonomy_breakdown$families` families, which accounted for ~36% of the known crab diversity reported from Hawaiian waters [@castroCatalogAnomuranBrachyuran2011]. The four most abundant species were: `r with(all_summary,top_list(top,top_n,top_units,fig="fig_crabs"))`. There were `r all_summary$singleton_count` singleton taxa (morpho/species occurring in a single unit across all sites), accounting for ~`r num(all_summary$singleton_count/ntaxa(cc$crabs_untransformed)*100,1)`% of total recovered crab species. <!--`r str_to_sentence(english(all_summary$singleton_count))` species occurred in a single unit across all sites (singletons), accounting for ~`r num(all_summary$singleton_count/ntaxa(cc$crabs_untransformed)*100,1)`% of total recovered crab species.--> 

![The four most abundant crab species found across all deployed ARMS units. (a) *Chlorodiella laevissima*. (b) *Perinia tumida*. (c) *Percnon abbreviatum*. (d) *Dynomene hispida*. Photo credit: Florida Museum of Natural History, licensed [CC BY-NC 3.0](https://creativecommons.org/licenses/by-nc/3.0/)](data/images/4crabs.png){#fig:fig_crabs}

<br><br>

### Mesophotic ARMS {-}

The `r nsamples(cc$crabs_deep)` units deployed at mesophotic depths $\geq$ 30 m on O&#x02BB;ahu yielded fewer species and individuals compared to the complete dataset, with `r num(sum(sample_sums(cc$crabs_deep)),1)` crabs overall, `r sum(unlist(deep_summary$types_breakdown))` distinct types (`r deep_summary$types_breakdown$species` species and `r deep_summary$types_breakdown$morphospecies` morphospecies), `r num(deep_summary$abundance_mean,0.1)` $\pm$ `r num(deep_summary$abundance_sd,0.1)` individuals per unit, and abundance ranging from `r format_range(deep_summary$abundance_range)`. The four most abundant taxa in the deep ARMS did not overlap with those from the complete dataset: `r with(deep_summary,top_list(top,top_n,top_units))`. There were `r deep_summary$singleton_count` singletons, which proportionally accounted for ~`r num(deep_summary$singleton_count/ntaxa(cc$crabs_deep)*100,1)`% of species found on deep ARMS. 

## Alpha diversity {-}

### Summary {-}

Overall mean species richness for the complete dataset was `r num(all_alpha$richness,0.1)` $\pm$ `r num(all_alpha$richness_sd,0.1)` species per unit (effective Simpson diversity: `r num(all_alpha$simpson,0.01)` $\pm$ `r num(all_alpha$simpson_sd,0.01)`). Overall mean species richness for shallow ARMS \< 30 m was `r num(shallow_alpha$richness,0.1)` $\pm$ `r num(shallow_alpha$richness_sd,0.1)` species per unit (effective Simpson diversity: `r num(shallow_alpha$simpson,0.01)` $\pm$ `r num(shallow_alpha$simpson_sd,0.01)`). Overall mean species richness for mesophotic ARMS $\geq$ 30 m was `r num(deep_alpha$richness,0.1)` $\pm$ `r num(deep_alpha$richness_sd,0.1)` species per unit (effective Simpson diversity: `r num(deep_alpha$simpson,0.01)` $\pm$ `r num(deep_alpha$simpson_sd,0.01)`). 

### Comparisons {-}

For the complete dataset, there was no significant difference in observed species richness between the MHI and NWHI ([@fig:fig_alpha[]{}a]; `r k_test(all_alpha$k_r_island)`), but effective Simpson diversity was significantly different ([@fig:fig_alpha[]{}c]; `r k_test(all_alpha$k_s_island,plain=TRUE)`). Richness was not significantly different between shallow and deep samples ([@fig:fig_alpha[]{}b]; `r k_test(all_alpha$k_r_depth,plain=TRUE)`) but effective Simpson diversity was ([@fig:fig_alpha[]{}d]; `r k_test(all_alpha$k_s_depth,plain=TRUE)`). When only shallow arms \< 30 m were considered, there were no significant differences in alpha diversity between the MHI and NWHI for either index (richness: `r k_test(shallow_alpha$k_r_island,plain=TRUE)`, [@fig:fig_alpha2[]{}a]; effective Simpson: `r k_test(shallow_alpha$k_s_island,plain=TRUE)`, [@fig:fig_alpha2[]{}b]).

<!--For the complete dataset, there was no significant difference in observed species richness between the MHI and NWHI `r w_test(all_alpha$w_r_island)`, but effective Simpson diversity was significantly different ([@fig:fig_alpha[]{}a]; `r w_test(all_alpha$w_s_island,plain=TRUE)`). When only shallow arms \< 30 m were considered, neither comparison was significant (richness: `r w_test(shallow_alpha$w_r_island,plain=TRUE)`; effective Simpson: `r w_test(shallow_alpha$w_s_island,plain=TRUE)`). Effective Simpson diversity was significantly different between shallow and deep samples ([@fig:fig_alpha[]{}b]; `r w_test(all_alpha$w_s_depth,plain=TRUE)`) but richness was not (`r w_test(all_alpha$w_r_depth,plain=TRUE)`).  -->

<!--For the complete dataset, there was no significant difference in observed species richness between the MHI and NWHI `r t_test(all_alpha$t_r_island)`, but effective Simpson diversity was significantly different ([@fig:fig_alpha[]{}a]; `r t_test(all_alpha$t_s_island,plain=TRUE)`). When only shallow arms \< 30 m were considered, neither comparison was significant (richness: `r t_test(shallow_alpha$t_r_island,plain=TRUE)`; effective Simpson: `r t_test(shallow_alpha$t_s_island,plain=TRUE)`). Effective Simpson diversity was significantly different between shallow and deep samples ([@fig:fig_alpha[]{}b]; `r t_test(all_alpha$t_s_depth,plain=TRUE)`) but richness was not (`r t_test(all_alpha$t_r_depth,plain=TRUE)`).  -->

<!-- ### Effects of environmental variables {-} -->
## Brachyuran community structure {-}

```{r dbrda-analysis, results="hide", dependson="init"}
library(formula.tools)

reduce_model <- function(m,o,d,vif_limit=3,condition=character()) {
  vifs <- vif.cca(m)
  if (any(vifs > vif_limit)) {
    oldterms <- rhs.vars(m$call$formula)
    v <- names(vifs)[which.max(vifs)]
    newterms <- grep(v,oldterms,value=TRUE,invert=TRUE)
    f <- reformulate(newterms,response=quote(o))
    newmod <- dbrda(f,data=d,distance="bray")
    reduce_model(newmod,o,d,vif_limit,condition)
  } else {
    return(m)
  }
}

# calculate full dbRDA model
db_modl <- dbrda(
  cc$crab_otus_shallow ~ depth +
    chl + sst + slope + coral_cover +
    larval_connectivity + human_impact +
    Condition(recovery_year),
  data=cc$crab_data_shallow,
  distance="bray"
)

# get rid of variables with VIF > 3
db_modl <- reduce_model(db_modl,cc$crab_otus_shallow,cc$crab_data_shallow)

# calculate biplot vectors and magnitudes
vectors <- db_modl %>%
  scores(display="bp") %>%
  as_tibble(rownames="term") %>%
  inner_join(model_terms %>% select(variable,driver=`Environmental Driver`),by=c("term" = "variable")) %>%
  mutate(size = sqrt(dbRDA1^2 + dbRDA2^2), driver=str_to_lower(driver)) %>%
  arrange(desc(size))

# get marginal term information and sort by descending f-statistic
modl_perm <- anova(db_modl,by="margin") %>%
  broom::tidy() %>%
  arrange(desc(statistic)) 

# make a nicer display-worthy table for significant terms
rda_table <- modl_perm %>%
  inner_join(model_terms %>% select(variable,driver=`Environmental Driver`),by=c("term" = "variable")) %>%
  select(-term) %>%
  select(Term=driver,DF=df,`Sum of Squares`=SumOfSqs,`F-statistic`=statistic,`p-value`=p.value)

# get number of model terms
tt <- attr(db_modl$terms,"term.label")
nterm <- length(grep("Condition",tt,ignore.case = FALSE,value=TRUE,invert = TRUE))

# get top drivers for the text
drivers <- rda_table %>%
  slice(1:2) %>%
  select(term=Term,stat=`F-statistic`,pval=`p-value`)  %>%
  mutate(term=str_to_lower(term))
```
### Environmental drivers {-}
Environmental variables were strongly clustered according to island group (MHI vs NWHI) ([@fig:fig_pca]). The best dbRDA model (`r permanova(db_modl,stat="F")`) explained `r pc(RsquareAdj(db_modl)$adj.r.squared,0.01)` (adjusted $\mathrm{R}^2$) of the variability in crab communities across the archipelago ([@fig:fig_dbrda]). `r str_to_sentence(english(nterm))` of the seven environmental variables tested were significant and sufficiently uncorrelated.<!--TODO: make "chlorophyll-a" look like "chlorophyll-A"--> The two drivers contributing most to explained variation were `r drivers$term[1]` (F = `r num(drivers$stat[1],0.01)`) and `r drivers$term[2]` (F = `r num(drivers$stat[2],0.01)`) ([@tbl:rda_table]), although the two factors with the longest effect vectors on the dBRDA plot were `r vectors$driver[1]` and `r vectors$driver[2]` ([@fig:fig_dbrda]). 

```{r fig-dbrda, fig.cap="dbRDA plot showing significant drivers of crab community variation across the Hawaiian Islands. Colored ellipses represent 95% confidence intervals around island groups.", results="asis", fig.width=9, fig.height=6, dependson="rda-analysis"}
termz <- model_terms %>%
  select(variable,display=`Environmental Driver`)

# make the initial ordination plot
rda_plotz <- plot_ord(cc$crabs_shallow,db_modl,scale=2,color="island_group",labelsize=3,term_map=termz) + 
  stat_ellipse(geom="polygon",aes(group=island_group,fill=island_group),color=NA,alpha=0.1,show.legend = FALSE) +
  geom_point(aes(fill=island_group),shape=21,color="black",size=3) +
  plotz_theme() + 
  scale_fill_manual(name="Island group",values=island_group_pal,labels = c("Main","Northwest")) +
  guides(color = "none")

# calculate variation explained (constrained & unconstrained)
eigs <- eigenvals(db_modl)
constrained <- eigs[str_detect(names(eigs),"dbRDA")]
constrained <- constrained / sum(constrained)
unconstrained <- eigs/sum(eigs)

# function to format axis titles
splained <- function(name,constrained,total,accuracy=0.1) {
  str_glue("{name} ({pc(constrained,accuracy)} constrained, {pc(total,accuracy)} total)")
}

axes <- str_glue_data(list(num=1:2),"dbRDA{num}")
axis_var <- splained(axes,constrained[1:2],unconstrained[1:2])

# put the arrows on top
rda_plotz$layers <- rda_plotz$layers[c(1,2,5,6,3,4)]

# plot the plotz
rda_plotz + 
  xlab(axis_var[1]) + ylab(axis_var[2])
cat("{#fig:fig_dbrda}")
```

<br><br>

### Regional & depth comparisons {-}

```{r permanova, dependson="init"}
anova_region <- adonis2(cc$crab_dist_shallow ~ island_group,data=cc$crab_data_shallow,permutations=PERM)
anova_island <- adonis2(cc$crab_dist_shallow ~ island,data=cc$crab_data_shallow,permutations=PERM)
bd_region <- betadisper(cc$crab_dist_shallow,cc$crab_data_shallow$island_group)

anova_depth <- adonis2(cc$crab_dist ~ depth_zone,data=cc$crab_data,permutations=PERM)
bd_depth <- betadisper(cc$crab_dist,cc$crab_data$depth_zone)

anova_both <- adonis2(cc$crab_dist ~ island_group + depth_zone, data=cc$crab_data,permutations = PERM, by="margin")
effects <- broom::tidy(anova_both) %>%
  filter(!term %in% c("Residual","Total")) %>%
  pull(R2)
effect_ratio <- max(effects)/min(effects)

cd <- cc$crabs_deep %>%
  sample_tibble()
bd_deep <- betadisper(distance(cc$crabs_deep,"bray"),cd$depth_zone)
```

```{r cap-analysis,dependson="init",echo=FALSE,message=FALSE,warning=FALSE,results="hide"}
# convert otu tables and sample data into appropriate format
otus <- otu_table(cc$crabs) %>%
  as.data.frame()
cd <- cc$crab_data %>%
  mutate(sample_group = factor(sample_group,ordered=FALSE)) %>%
  as.data.frame()

# run CAP analysis, taking care of negative eigenvalues where necessary
cap_depth <- CAPdiscrim(otus ~ sample_group, data=cd, dist="bray", axes=2, m=0, add=TRUE)
# # calculate proportion of explained variance
cap_var <- cap_depth$manova$Eigenvalues / sum(cap_depth$manova$Eigenvalues)
cap_var <- list(x = cap_var[1], y = cap_var[2])

# make the sample group look nice
nice <- function(s) {
  str_replace(s,"shallow","Shallow") %>%
    str_replace("main","(MHI)") %>%
    str_replace("nwhi","(NWHI)") %>%
    str_replace("(^[0-9]+)","O‚Äòahu \\1") %>%
    str_split("((?<=[0-9])(?=[a-zA-Z]))|(_)") %>%
    map_chr(~str_c(.x,collapse=" "))
}

# get all the stuff we need to plot
pcap <- cap_depth$x %>%
  as_tibble(rownames="sample") %>%
  left_join(cd,by="sample") %>%
  mutate(
    sample_group = nice(sample_group),
    sample_group = fct_reorder(sample_group,depth)
  )

shallow_dist <- pcap %>%
  filter(shallow_deep == "shallow") %>%
  select(sample,LD1,LD2) %>%
  column_to_rownames("sample") %>%
  dist() 
  
deep_dist <- pcap %>%
  filter(shallow_deep == "deep") %>%
  select(sample,LD1,LD2) %>%
  column_to_rownames("sample") %>%
  dist()
```
Shallow crab community structure was significantly different between island groups (MHI vs. NWHI) (`r permanova(anova_region,0.01)`) as well as among individual islands (`r permanova(anova_island,0.01)`; see [@fig:fig_pairwise] for results of pairwise comparisons). There was no significant difference in community dispersion between the MHI and NWHI (`r permdisp(bd_region)`). When mesophotic ($\geq$ 30 m) ARMS units were included, there were significant differences among depth zones (\< 30 m, 30 m, 60 m, 90 m) (`r permanova(anova_depth,0.01)`) and community dispersion (`r permdisp(bd_depth)`). However, community dispersion was not different among depth zones $\geq$ 30 m (`r permdisp(bd_deep)`). Although crab communities were significantly different among both depth zones and island groups for the complete dataset (`r permanova(anova_both,0.01)`), depth explained `r num(effect_ratio,0.1)` times more variability than island group (based on model $\mathrm{R}^2$). 

In the CAP analysis of island group and depth zone, ARMS units were correctly reassigned to groups `r pc(cap_depth$percent/100,0.1)` of the time. The first two axes explained `r pc(cap_var$x,0.1)` and `r pc(cap_var$y,0.1)` of the variation, respectively. Mesophotic samples (30--90 m) from O&#x02BB;ahu grouped separately from shallow samples collected across the entire ~2,500 km expanse of the archipelago ([@fig:fig_cap]). Additionally, variability among 30--90 m samples was greater than among all shallow samples, (max. Euclidean distance between shallow samples in the CAP ordination: `r num(max(shallow_dist),0.01)`, avg. `r num(mean(shallow_dist),0.01)`; max. Euclidean distance between deep samples: `r num(max(deep_dist),0.01)`, avg. `r num(mean(deep_dist),0.01)`) ([@fig:fig_cap]).

```{r fig-cap, fig.cap="CAP plot of crab communities by island group and depth zone.", results="asis", fig.width=9, fig.height=6, dependson="cap-analysis"}
centroids <- pcap %>% group_by(sample_group) %>%
  summarise(LD1=mean(LD1),LD2=mean(LD2))

ggplot(pcap,aes(x=LD1,y=LD2,fill=sample_group)) + 
  stat_ellipse(geom="polygon",level=0.95,alpha=0.1,show.legend = FALSE) +
  geom_point(color="black",shape=21,size=5)  +
  geom_label_repel(data=centroids,aes(label=sample_group), color="white", show.legend = FALSE) + 
  scale_fill_manual(values=sample_depth_pal,name="Sample group") +
  xlab(str_glue("Linear discriminant 1 [{pc(cap_var$x,0.1)}]")) +
  ylab(str_glue("Linear discriminant 2 [{pc(cap_var$y,0.1)}]")) +
  plotz_theme()
cat("{#fig:fig_cap}")
```

<br><br>

# Discussion {-}
Marine communities are structured by a suite of factors, but there remains no consensus for either generalized mechanisms or the relative importance of drivers of community structure for coral reefs. Our best knowledge of the role of depth in structuring marine communities comes from the intertidal, and points to biotic factors (e.g., predation, competition) determining lower limits and abiotic factors (e.g., desiccation, thermal stress) setting upper limits of vertical species distributions [@connellEffectsCompetitionPredation1961; @connellInfluenceInterspecificCompetition1961; @dennyPhysicalProcessesThat2001; @paineIntertidalCommunityStructure1974]. However, abiotic stressors on intertidal communities are obviously different from those on coral reefs, and generalizations about the mechanisms and ecological processes that structure coral reef communities remain a subject of considerable debate [@bellwoodEnvironmentalGeometricConstraints2005; @bellwoodSleepingFunctionalGroup2006; @carrBiodiversityPopulationRegulation2002; @connollyIndoPacificBiodiversityCoral2003; @dornelasCoralReefDiversity2006; @grahamImportanceStructuralComplexity2013; @komyakovaRelativeImportanceCoral2013]. In the Hawaiian archipelago, we found significant differences in the composition of coral reef crab communities between the populated high islands of the MHI and the uninhabited atolls of the NWHI. Moreover, these differences were driven by a combination of environmental (sea-surface temperature, chlorophyll concentration, depth), biotic (potential larval immigration), and anthropogenic (cumulative human impacts) factors.  

The Hawaiian Archipelago is among the most remote oceanic island chains on the planet and encompasses a range of gradients (anthropogenic, biotic, abiotic), making it an ideal natural laboratory to study the impacts of various drivers of species assemblages across space. Human activities are considerably higher in the populated MHI than in the protected and remote NWHI [@selkoeEvaluatingAnthropogenicThreats2008; @selkoeMapHumanImpacts2009; @selkoeDNACoralReef2016]. Although we did not consider the effects of individual drivers here, an index representing cumulative anthropogenic impacts was the top driver of brachyuran community structure, similar to findings in previous work examining genetic diversity, species richness and habitat area, quality and stability across the archipelago [@selkoeDNACoralReef2016]. The next-most significant driver, chlorophyll A, can be used as a proxy for primary productivity. Productivity gradients across the Hawaiian Archipelago coincide with differences in coral reef community composition [@selkoeDNACoralReef2016], endemic reef fish dominance [@friedlanderDominanceEndemicsReef2020], survival rates of top predators [@bakerEffectVariableOceanic2007], and island geomorphology [@goveNearislandBiologicalHotspots2016]. Thus, it is not surprising that we find the same top drivers of community structure for one of the primary taxonomic groups inhabiting coral reefs, the brachyuran crabs, across the Hawaiian archipelago. What is surprising is the consistent significance of depth as a primary driver of community composition across these gradients.

Even though our shallow-water ARMS units were deployed within a narrow depth range (8--17 m), depth still emerged as a significant and consistent driver of community variation among these units. Depth in and of itself is unlikely to affect marine community composition. At the same time, oceanographic factors with well-known depth profiles (e.g., temperature, light, oxygen, nutrients, etc.) are not expected to vary dramatically across such a narrow depth range (\< 10 m), although fine-scale habitat variability among sites may also be driving the community differences we found [@steyaertRemoteReefCryptobenthic2022]. Unfortunately, we lack environmental data at depth for each ARMS site, and thus cannot unravel the co-varying factor(s) associated with the depth effects we observed. Regardless, given its significance across both narrow (\< 10 m) and wider (90 m) depth ranges sampled here, depth (or an associated factor) is clearly an important driver for cryptobenthic crab communities across the Hawaiian Archipelago. Given brachyurans are a ubiquitous and important component of coral reef communities [@reynsPatternsProcessesBrachyuran1999; @lasleyjrPhylogeneticRelationshipsUbiquitous2015; @hazeriLatitudinalSpeciesDiversity2019], these findings are likely to apply more broadly as well.

While depth was a significant driver of community composition among shallow-water ARMS units, its influence was even more apparent when comparing shallow to mesophotic samples. Due to logistical constraints (and the limitations of satellite-derived data products), our environmental data only covers shallow-water deployments, but CAP ordinations show considerable differences between the grouping of all shallow communities and the units deployed $\geq$ 30 m at the single island of O&#x02BB;ahu ([@fig:fig_cap]). In other words, there was more community variation across 90 m of depth on a single island than across 2,500 km of shallow habitat experiencing multiple gradients of environmental, ecological, and anthropogenic influence. The ordination revealed two visible clusters for mesophotic units: one containing the 30 m units and the other containing the 60 m and 90 m units. These two clusters coincide with what is regarded as the upper and lower mesophotic zones, respectively [@kahngCommunityEcologyMesophotic2010; @rochaMesophoticCoralEcosystems2018; but see @pyleMesophoticCoralEcosystems2019]. The upper mesophotic (~30--60 m) has often been considered as a continuation of shallow reefs while the lower mesophotic (~60--150 m) is primarily thought to constitute a unique community. This pattern has held true across various taxonomic groups [@lesserGlobalCommunityBreaks2019; @rochaMesophoticCoralEcosystems2018], but our data show more distinct separations among shallow, upper, and lower mesophotic depths (although 30 m appears to represent an upper-to-lower transition zone).  

In addition to community composition, mesophotic samples also contributed to alpha diversity differences across the archipelago. We found significant differences in effective Simpson diversity between the MHI and NWHI, but only when mesophotic samples were included in the comparison; when deep ARMS units were left out, these comparisons were non-significant. When comparing shallow to mesophotic, effective Simpson diversity was significantly (if slightly) higher in deep communities. Thus, the apparent overall differences in alpha diversity between the MHI and NWHI can be attributed entirely to the deep samples from the island of O&#x02BB;ahu. This pattern is likely driven by species unique to mesophotic habitat [@hurleyAssessmentShallowMesophotic2016]. 

Our depth transect was limited to O&#x02BB;ahu, but community and alpha diversity differences among depth zones at that single island appear to overwhelm differences observed among shallow-water coral reef habitat across the archipelago. Similar patterns were found at a local scale (tens of kilometers) on Hawai&#x02BB;i Island using environmental DNA (eDNA) [@hobanPlumbingDepthsEnvironmental2023]. In that study, communities were found to have more affinity across sites within depth zones than among depth zones within sites. These results and the patterns we observed suggest that depth-associated factors exert stronger ecological influence than those that vary across the latitudinal, physical, and anthropogenic gradients throughout the Hawaiian Archipelago. 

Since we lack environmental data for mesophotic samples, we cannot make conclusions about the specific influences driving the differences we found. However, light and temperature have been proposed to be important with regard to depth zonation in benthic communities [@kahngCommunityEcologyMesophotic2010; @lesserGlobalCommunityBreaks2019; @pyleComprehensiveInvestigationMesophotic2016; @pyleMesophoticCoralEcosystems2019]. Oceanographic conditions may be inconsistent close to shore, but the average mixed-layer depth calculated (using 0.8 &deg;C $\upDelta$T [@karaOptimalDefinitionOcean2000]) from CTD casts taken at station ALOHA (22.75&deg;N, 158.00&deg;W; within the latitudinal expanse of the MHI) was 84.6 $\pm$ 26 m over the course of the year (based on monthly averages from casts taken across the duration of ARMS unit deployments [@HawaiiOceanTimeseries]). Thus, given the assumption of similar temperature profiles near the O&#x02BB;ahu shoreline, temperature alone appears insufficient to explain the zonation patterns we observed. In contrast, the lower depth boundaries of mesophotic reef communities are largely determined by surface irradiance [@kahngCommunityEcologyMesophotic2010; @hindersteinThemeSectionMesophotic2010], so light seems a possible candidate to be a significant abiotic driver of community structure. 

Further work to investigate drivers of depth zonation could take advantage of established gradients and use the Hawaiian Archipelago as a natural laboratory. Coral reef biodiversity is generally thought to be structured at depth by a combination of the attenuation of light, a decrease in temperature, increasing salinity, and a reduction in trophic resources [@lesserEcologyMesophoticCoral2009; @kahngCommunityEcologyMesophotic2010; @slatteryFunctionStabilityMesophotic2024a]. If patterns of community structure are driven primarily by light, that may explain why even our shallow-water sites show a significant depth effect over less than 10m. The importance of light could be tested by sampling communities from the same irradiance level but different depths due to factors altering light penetration to determine if we see consistent patterns of community zonation. In contrast, other factors (such as dissolved inorganic nitrogen, particulate organic carbon, or productivity) expected to have more strongly-defined gradients across the regions [@slatteryFunctionStabilityMesophotic2024a], would lead to variable zonation patterns that should be detected in our comparison of the MHI & NWHI. Such differences should be tested in future studies to understand the specific physical and ecological drivers of coral reef depth zonation.

Regardless of the exact environmental and ecological drivers at play, our findings suggest that the classical model of intertidal zonation with biotic and abiotic drivers could likely be reversed for coral reef ecosystems. *Lower* limits of mesophotic coral reef ecosystems are likely determined by abiotic factors that correlate with depth, whereas *upper* limits may be driven by ecological interactions. By comparing shallow-water ARMS across the latitudinal, physical and anthropogenic gradients of the Hawaiian Archipelago, we were able to test the relative importance of the significant drivers of community structure. Our analysis corroborates previous work and shows depth is the strongest driver of community structure. We find that a 90 m depth transect at a single site shows greater divergence in canonical space than the full 2,500 km gradient of the Hawaiian Archipelago for shallow-water ARMS. We conclude that some factor(s) that covary with depth exert more influence on the cryptobenthic coral reef community structure than those biotic and abiotic gradients that span the entire Hawaiian Archipelago in shallow-water environments.

# Acknowledgements
We thank the Coral Reef Conservation Program for supporting the deployment and recovery of the shallow ARMS. We thank the UH MƒÅnoa Dive Safety Office (D. Pence, K. Stender, J. Jones, and C.J. Bradley) for installation and retrieval of the mesophotic ARMS. We thank Joshua Copus and Kevin Flanagan for additional assistance with retrieval and processing of mesophotic ARMS units. We thank the ToBo laboratory members, particularly M. Iacchei, C. Ka&#x02BB;apu-Lyons, and Z. Hee, for discussion, support, and their efforts in the disassembly and sorting of ARMS samples on retrieval. This is contribution #xxx from the Hawai&#x02BB;i Institute of Marine Biology and #xxx from the School of Earth Science and Technology at the University of Hawai&#x02BB;i.

# Funding
This work was funded through a combination of grants including NSF OCE 12-60169, NSF GRFP DGE-1329626, and NSF-2048457. In addition, the NOAA Coral Reef Conservation Program funded the Pacific Reef Assessment and Monitoring Program, which included the shallow ARMS deployment in the Hawaiian Archipelago.

# References {-}

::: {#refs}
:::

\newpage

# Supplemental material {label="S"}

## Processing of satellite-derived environmental data
Level-3 mapped (9km) sea-surface temperature (SST) and chlorophyll A (chl-A) data were retrieved from NASA's Physical Oceanography Distributed Active Archive Center [PO.DAAC; @https://doi.org/10.5067/modsa-mo9d9] and Ocean Biology Distributed Active Archive Center [OB.DAAC; @NASAOceanBiologyProcessingGroup_2022] respectively. Monthly summary datasets were downloaded for the period of 2009--2016 and averaged over each of the ARMS unit soaking periods (e.g. 2009--2011, 2010--2012, etc.). Values (SST or chl-A) were extracted for the geographic coordinates of each sampling site from the averaged dataset for the relevant soaking period. Specific monthly-average dataset names can be found in @tbl:nasa_table.

```{r fig-alpha, fig.cap='Box plots of (a,b) species richness and (c,d) effective Simpson diversity for complete dataset (all sampled depths). Asterisks indicate significant differences (K-W test). Notches represent nonparametric confidence intervals about the median. (a) Species richness by island group. (b) Species richness by sampling depth. (c) Effective Simpson diversity by island group. (d) Effective Simpson diversity by sampling depth.', results="asis", dev="svg", fig.width=10, fig.height=10, dependson="init"}
library(patchwork)

  
art <- all_alpha$richness_table %>% 
  mutate(island_group = str_to_sentence(island_group)) %>%
  mutate(shallow_deep = str_to_sentence(shallow_deep),shallow_deep = fct_reorder(shallow_deep,depth))


if (all_alpha$k_r_island$p.value < 0.05) {
  which_max <- art %>% 
    group_by(island_group) %>% 
    summarise(r = mean(Observed)) %>%
    slice(which.max(r)) %>%
    pull(island_group) %>%
    as.character()
  max_r <- max(art$Observed) + (diff(range(art$Observed)))/10
  sig <- tribble(
    ~x,~y,
    which_max,max_r
  ) 
} else {
  sig <- tribble(~x,~y)
}

pointsize <- 5


p1 <- ggplot(art) + 
  geom_boxplot(aes(x=island_group,y=Observed,fill=island_group),notch=TRUE) +
  geom_point(aes(x,y),data=sig,shape=8,size=pointsize,stroke=1.5) + 
  scale_fill_manual(values=island_group_pal) +
  guides(fill="none") + 
  plotz_theme() + 
  xlab("Island group") + 
  ylab("Richness") 


if (all_alpha$k_r_depth$p.value < 0.05) {
  which_max <- art %>% 
    group_by(shallow_deep) %>% 
    summarise(r = mean(Observed)) %>%
    slice(which.max(r)) %>%
    pull(shallow_deep) %>%
    as.character()
  max_r <- max(art$Observed) + (diff(range(art$Observed)))/10
  sig <- tribble(
    ~x,~y,
    which_max,max_r
  ) 
} else {
  sig <- tribble(~x,~y)
}

p2 <- ggplot(art) + 
  geom_boxplot(aes(x=shallow_deep,y=Observed,fill=shallow_deep),notch=TRUE) +
  geom_point(aes(x,y),data=sig,shape=8,size=pointsize,stroke=1.5) + 
  scale_fill_manual(values=sample_depth_pal) +
  guides(fill="none") + 
  plotz_theme()  + 
  xlab("Sampling depth") + 
  ylab("Richness") 

if (all_alpha$k_s_island$p.value < 0.05) {
  which_max <- art %>% 
    group_by(island_group) %>% 
    summarise(r = mean(Simpson)) %>%
    slice(which.max(r)) %>%
    pull(island_group) %>%
    as.character()
  max_r <- max(art$Simpson) + (diff(range(art$Simpson)))/10
  sig <- tribble(
    ~x,~y,
    which_max,max_r
  ) 
} else {
  sig <- tribble(~x,~y)
}

pointsize <- 5

p3 <- ggplot(art) + 
  geom_boxplot(aes(x=island_group,y=Simpson,fill=island_group),notch=TRUE) +
  geom_point(aes(x,y),data=sig,shape=8,size=pointsize,stroke=1.5) + 
  scale_fill_manual(values=island_group_pal) +
  guides(fill="none") + 
  plotz_theme() + 
  xlab("Island group") + 
  ylab("Effective Simpson diversity") 

if (all_alpha$k_s_depth$p.value < 0.05) {
  which_max <- art %>% 
    group_by(shallow_deep) %>% 
    summarise(r = mean(Simpson)) %>%
    slice(which.max(r)) %>%
    pull(shallow_deep) %>%
    as.character()
  max_r <- max(art$Simpson) + (diff(range(art$Simpson)))/10
  sig <- tribble(
    ~x,~y,
    which_max,max_r
  ) 
} else {
  sig <- tribble(~x,~y)
}

p4 <- ggplot(art) + 
  geom_boxplot(aes(x=shallow_deep,y=Simpson,fill=shallow_deep),notch=TRUE) +
  geom_point(aes(x,y),data=sig,shape=8,size=pointsize,stroke=1.5) + 
  scale_fill_manual(values=sample_depth_pal) +
  guides(fill="none") + 
  plotz_theme()  + 
  xlab("Sampling depth") + 
  ylab("Effective Simpson diversity") 

(p1 + p2) / (p3 + p4) & 
  plot_annotation(tag_levels = list(str_glue("({letters[1:4]})"))) & 
  theme(plot.tag = element_text(face="italic"))
cat("{#fig:fig_alpha}")
```

\newpage

```{r fig-alpha2, fig.cap='Box plots of (a) species richness and (b) Effective Simpson diversity by island group for shallow samples only. Notches as in [@fig:fig_alpha]. Both comparisons are non-significant.', results="asis", dev="svg", fig.width=8, fig.height=4, dependson="init"}
art <- shallow_alpha$richness_table %>% 
  mutate(island_group = str_to_sentence(island_group)) %>%
  mutate(shallow_deep = str_to_sentence(shallow_deep),shallow_deep = fct_reorder(shallow_deep,depth))

if (shallow_alpha$k_r_island$p.value < 0.05) {
  which_max <- art %>% 
    group_by(island_group) %>% 
    summarise(r = mean(Observed)) %>%
    slice(which.max(r)) %>%
    pull(island_group) %>%
    as.character()
  max_r <- max(art$Observed) + (diff(range(art$Observed)))/10
  sig <- tribble(
    ~x,~y,
    which_max,max_r
  ) 
} else {
  sig <- tribble(~x,~y)
}

pointsize <- 5

  
p1 <- ggplot(art) + 
  geom_boxplot(aes(x=island_group,y=Observed,fill=island_group),notch=TRUE) +
  geom_point(aes(x,y),data=sig,shape=8,size=pointsize,stroke=1.5) + 
  scale_fill_manual(values=island_group_pal) +
  guides(fill="none") + 
  plotz_theme() + 
  xlab("Island group") + 
  ylab("Richness") 

if (shallow_alpha$k_s_island$p.value < 0.05) {
  which_max <- art %>% 
    group_by(island_group) %>% 
    summarise(r = mean(Simpson)) %>%
    slice(which.max(r)) %>%
    pull(island_group) %>%
    as.character()
  max_r <- max(art$Simpson) + (diff(range(art$Simpson)))/10
  sig <- tribble(
    ~x,~y,
    which_max,max_r
  ) 
} else {
  sig <- tribble(~x,~y)
}

pointsize <- 5

p2 <- ggplot(art) + 
  geom_boxplot(aes(x=island_group,y=Simpson,fill=island_group),notch=TRUE) +
  geom_point(aes(x,y),data=sig,shape=8,size=pointsize,stroke=1.5) + 
  scale_fill_manual(values=island_group_pal) +
  guides(fill="none") + 
  plotz_theme() + 
  xlab("Island group") + 
  ylab("Effective Simpson diversity") 

(p1 + p2) & 
  plot_annotation(tag_levels = list(str_glue("({letters[1:2]})"))) & 
  theme(plot.tag = element_text(face="italic"))
cat("{#fig:fig_alpha2}")
```

\newpage

```{r fig-pca, fig.cap='Principal component analysis (PCA) of environmental variables by sampling site. Ellipses represent 95% confidence intervals around island groups.', results='asis', dev='svg', fig.width=8,fig.height=8, dependson='init'}
cds <- cc$crab_data_shallow

pcdata <- cds %>%
  select(where(is.numeric),-c(lon,lat),-closest_island)

pca <- prcomp(pcdata)
explained <- (pca$sdev^2)/sum(pca$sdev^2)

bp <- cds %>%
  bind_cols(scores(pca))

loadings <- pca$rotation %>%
  as_tibble(rownames = "label") %>%
  mutate(
    PC1 = PC1*3,
    PC2 = PC2*3,
    hjust = if_else(PC1 < 0,1,0),
    xnudge = if_else(PC1 < 0,-0.02,0.02)
  )

ggplot(bp,aes(x=PC1,y=PC2)) + 
  geom_point(aes(fill=island_group),shape=21,color="black",size=4) +
  stat_ellipse(geom="polygon",aes(group=island_group,fill=island_group),color=NA,alpha=0.1,show.legend = FALSE) +
  # geom_mark_ellipse(color="black",alpha=0.2,show.legend=FALSE, linewidth=0.07) +
  scale_fill_manual(values=island_group_pal) + 
  geom_segment(data=loadings,aes(x=0,y=0,xend=PC1,yend=PC2),color="black",size=0.5,arrow=arrow(length=unit(0.02,"npc"))) + 
  geom_label(data=loadings,aes(x=PC1+xnudge,y=PC2,label=label,hjust=hjust)) + 
  xlab(str_glue("PC1 [{pc(explained[1])}]")) + 
  ylab(str_glue("PC2 [{pc(explained[2])}]")) + 
  plotz_theme()
cat("{#fig:fig_pca}")
```

\newpage

```{r pairwise-island, fig.cap='Results of pairwise PERMANOVA tests by island for shallow crab communities (p-values adjusted according to the false discovery rate [@benjaminiControllingFalseDiscovery1995]). Significant comparisons presented in bold.', results="asis", dev="svg", fig.width=12, fig.height=9, dependson="init"}
pairwise_island <- pairwise_adonis(cc$crab_dist_shallow,cc$crab_data_shallow$hawaiian_name,permutations=PERM)

pw <- pairwise_island %>%
  filter(p_adj < 0.05)

islands <- cc$crabs_shallow %>%
  sample_tibble() %>%
  pull(hawaiian_name) %>%
  levels()

pw1 <- pairwise_island %>%
  select(left,right,p_adj,pseudo_f) %>%
  mutate(left=factor(left,levels=rev(islands)),right=factor(right,levels=rev(islands))) %>%
  mutate(sig = round(p_adj,2) < 0.05, p_adj = pval(p_adj), f = str_glue("F = {num(pseudo_f)}")) %>%
  mutate(
    combo = map2_chr(left,right,~str_c(sort(c(.x,.y)),collapse="-"))
  ) %>%
  select(-c(left,right)) %>%
  separate_wider_delim(combo,"-",names=c("left","right")) %>%
  select(left,right,everything()) %>%
  mutate(left=factor(left,levels=islands),right=factor(right,levels=islands)) %>%
  mutate(txt = str_glue("{p_adj}<br>{f}"))

ggplot(pw1) + 
  geom_richtext(
    aes(
      x=right,
      y=left,
      label=txt,
      fontface = if_else(sig,"bold","plain")
    ),
    fill = NA,
    label.color = NA
    # size=10
  ) +
  plotz_theme() +
  theme(
    panel.border = element_blank(),
    axis.line = element_line(color="black"),
    axis.text = element_text(size = 14),
    axis.text.x = element_text(angle=30,vjust=1,hjust=0)
  ) +
  guides(fill="none") +
  xlab("") + ylab("") +
  scale_x_discrete(position="top") +
  scale_y_discrete(limits=rev)
cat("{#fig:fig_pairwise}")
```

\newpage

```{r arms-metadata-table, results="asis", dependson="init"}
region_map <- c(
  'main' = 'MHI',
  'northwest' = 'NWHI',
  'mce' = 'MHI (mesophotic)'
)


arms_metadata <- cc$crabs_untransformed %>%
  sample_tibble() %>%
  # separate_wider_regex(sample,patterns=c(recovery_year="^[0-9]+","_",sample=".*"))  %>%
  # select(sample,everything()) %>%
  mutate(
    island = case_when(
      str_remove_all(hawaiian_name,'[^a-zA-Z ]') != island ~ as.character(str_glue("{hawaiian_name} ({island})")),
      TRUE ~ as.character(hawaiian_name)
    ),
    island = case_when(
      island == "O‚Äòahu" ~ str_glue("{hawaiian_name} ({shallow_deep})"),
      TRUE ~ island
    ),
    island = fct_reorder(island,-lat),
    region = region_map[region],
    lat = num(lat,0.0001),
    lon = num(lon,0.0001)
  ) %>%
  select(sample,region,island,depth,deployment_year,recovery_year,lat,lon) %>%
  janitor::clean_names(case="sentence")
print_table(arms_metadata,"arms_metadata_table","ARMS unit metadata",accuracy=1,hdr_case=NA,format_numbers=FALSE) 
```

\newpage

```{r rda-table,results="asis",dependson="rda-analysis"}
print_table(rda_table,"rda_table","Significant marginal terms in the dbRDA analysis of crab community variation across the Hawaiian Archipelago",hdr_case="none",accuracy=0.001) 
```

\newpage

```{r nasa-table,results="asis",depenson="init"}
nasa_table <- read_csv(here("data","tables","nasa.csv"))
print_table(nasa_table,"nasa_table","NASA data repository filenames for CHL and SST satellite data",accuracy=1,hdr_case=NA,format_numbers=FALSE) 
```
